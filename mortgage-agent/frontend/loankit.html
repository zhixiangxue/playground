<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è´·æ¬¾ä¿¡æ¯æ”¶é›† | å¿«é€Ÿé¢„å®¡</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="chatkit.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        body {
            background: #fff;
            color: #000;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 600;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .logo i {
            color: #000;
        }
        
        .subtitle {
            color: #666;
            font-size: 13px;
            font-weight: 400;
        }
        
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        
        .card-header {
            background: #f5f5f5;
            color: #000;
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card-header h2 i {
            font-size: 20px;
        }
        
        .card-body {
            padding: 24px;
        }
        
        .form-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            flex: 1 1 300px;
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .form-group label .info-tooltip {
            color: #999;
            cursor: help;
        }

        input, select, .radio-group, .checkbox-group {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background-color: #fff;
            box-sizing: border-box;
            color: #000;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #000;
            background-color: #fff;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            background: #f5f5f5;
        }
        
        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        .radio-option:hover, .checkbox-option:hover {
            background-color: #e0e0e0;
        }
        
        .radio-option input, .checkbox-option input {
            margin: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .progress-container {
            margin-bottom: 24px;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: #000;
            width: 25%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            gap: 12px;
        }
        
        .btn {
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #000;
            color: #fff;
            flex: 2;
        }
        
        .btn-primary:hover {
            background: #333;
        }
        
        .btn-primary:disabled {
            background: #999;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #fff;
            color: #000;
            border: 1px solid #e0e0e0;
            flex: 1;
        }
        
        .btn-secondary:hover {
            background-color: #f5f5f5;
        }
        
        .info-box {
            background-color: #f5f5f5;
            border-left: 3px solid #000;
            padding: 12px 16px;
            border-radius: 0 6px 6px 0;
            margin-top: 16px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 13px;
        }
        
        .info-box i {
            color: #000;
            font-size: 16px;
            margin-top: 2px;
        }
        
        .loan-type-indicator {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .qm {
            background-color: #e0e0e0;
            color: #000;
        }
        
        .non-qm {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .va {
            background-color: #f0f0f0;
            color: #000;
        }
        
        .jumbo {
            background-color: #e8e8e8;
            color: #000;
        }
        
        .hidden {
            display: none;
        }
        
        .summary-box {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        .summary-box::before {
            content: 'ğŸ”§ Debug Info';
            position: absolute;
            top: -10px;
            left: 16px;
            background-color: #666;
            color: white;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-box h4 {
            margin-bottom: 12px;
            color: #000;
            font-size: 13px;
            font-weight: 600;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .summary-item {
            padding: 10px;
            background-color: #fff;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .summary-label {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-weight: 600;
            color: #000;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .loan-result {
            padding: 12px;
            background-color: #fff;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-top: 8px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-header h4 {
            color: #000;
            font-size: 12px;
            font-weight: 600;
            margin: 0;
        }

        .rate-estimate {
            font-size: 14px;
            font-weight: 700;
            color: #000;
            font-family: 'Courier New', monospace;
        }

        .result-details {
            color: #666;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }

        /* åœ°ç‚¹æœç´¢æ ·å¼ */
        .location-search-container {
            position: relative;
        }

        .location-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .location-dropdown.show {
            display: block;
        }

        .location-category {
            background-color: #f5f5f5;
            padding: 8px 12px;
            font-weight: 600;
            color: #000;
            font-size: 12px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .location-options {
            max-height: 250px;
            overflow-y: auto;
        }

        .location-option {
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .location-option:hover {
            background-color: #f5f5f5;
        }

        .location-option.selected {
            background-color: #e0e0e0;
            color: #000;
        }

        .location-option-name {
            font-weight: 500;
            color: #000;
        }

        .location-option-state {
            font-size: 11px;
            color: #666;
            margin-left: 6px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 12px;
            }
            
            .form-group {
                flex: 1 1 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-bolt"></i> æƒ³äº†è§£ä¸€ä¸‹æ‚¨çš„è´·æ¬¾éœ€æ±‚</h2>
                </div>
                
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span>å¼€å§‹å¡«å†™</span>
                            <span id="progressPercent">25%</span>
                            <span>å®Œæˆ</span>
                        </div>
                    </div>
                    
                    <form id="loanForm">
                        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šæˆ¿äº§åŸºæœ¬ä¿¡æ¯ -->
                        <div class="form-section" id="section-property">
                            <h3 class="section-title"><i class="fas fa-home"></i> æˆ¿äº§åŸºæœ¬ä¿¡æ¯</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="propertyLocation">æˆ¿äº§åœ°ç‚¹</label>
                                    <div class="location-search-container" id="locationSearchContainer">
                                        <input type="text" id="propertyLocation" placeholder="æœç´¢åŸå¸‚ï¼Œä¾‹å¦‚ï¼šLos Angeles" required autocomplete="off">
                                        <div class="location-dropdown" id="locationDropdown">
                                            <div class="location-options" id="locationOptions"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="loanPurpose">è´·æ¬¾ç›®çš„</label>
                                    <select id="loanPurpose" required>
                                        <option value="">è¯·é€‰æ‹©è´·æ¬¾ç›®çš„</option>
                                        <option value="purchase">è´­ä¹°è‡ªä½æˆ¿</option>
                                        <option value="refinance">å†èèµ„/è½¬è´·</option>
                                        <option value="investment">æŠ•èµ„æˆ¿</option>
                                        <option value="second_home">ç¬¬äºŒå¥—æˆ¿</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="propertyType">æˆ¿äº§ç±»å‹</label>
                                    <select id="propertyType" required>
                                        <option value="">è¯·é€‰æ‹©æˆ¿äº§ç±»å‹</option>
                                        <option value="single_family">ç‹¬ç«‹å±‹</option>
                                        <option value="condo">å…¬å¯“</option>
                                        <option value="townhouse">è”æ’åˆ«å¢…</option>
                                        <option value="multi_unit">å¤šå•å…ƒä½å®…</option>
                                        <option value="commercial">å•†ä¸šåœ°äº§</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="propertyStatus">æˆ¿äº§ç°çŠ¶</label>
                                    <select id="propertyStatus" required>
                                        <option value="">è¯·é€‰æ‹©æˆ¿äº§ç°çŠ¶</option>
                                        <option value="pre_construction">åœ¨å»º/é¢„å”®</option>
                                        <option value="existing">ç°æˆ¿</option>
                                        <option value="foreclosure">æ³•æ‹æˆ¿</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šè´·æ¬¾è¯¦æƒ… -->
                        <div class="form-section" id="section-loan">
                            <h3 class="section-title"><i class="fas fa-file-invoice-dollar"></i> è´·æ¬¾è¯¦æƒ…</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="loanAmount">è´·æ¬¾é‡‘é¢ (USD)</label>
                                    <input type="number" id="loanAmount" placeholder="ä¾‹å¦‚ï¼š500000" min="0" step="10000" required>
                                </div>
                                <div class="form-group">
                                    <label for="downPayment">é¦–ä»˜æ¯”ä¾‹</label>
                                    <select id="downPayment" required>
                                        <option value="">è¯·é€‰æ‹©é¦–ä»˜æ¯”ä¾‹</option>
                                        <option value="0-5">0-5%</option>
                                        <option value="5-10">5-10%</option>
                                        <option value="10-20">10-20%</option>
                                        <option value="20+">20%+</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="creditScore">ä¿¡ç”¨åˆ†æ•°èŒƒå›´</label>
                                    <select id="creditScore" required>
                                        <option value="">è¯·é€‰æ‹©ä¿¡ç”¨åˆ†æ•°</option>
                                        <option value="300-579">300-579 (è¾ƒå·®)</option>
                                        <option value="580-669">580-669 (ä¸€èˆ¬)</option>
                                        <option value="670-739">670-739 (è‰¯å¥½)</option>
                                        <option value="740-799">740-799 (å¾ˆå¥½)</option>
                                        <option value="800-850">800-850 (ä¼˜ç§€)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="incomeType">æ”¶å…¥ç±»å‹ <span class="info-tooltip" title="è¿™æ˜¯ç¡®å®šè´·æ¬¾ç±»å‹çš„å…³é”®ä¿¡æ¯">â„¹ï¸</span></label>
                                    <select id="incomeType" name="incomeType" required>
                                        <option value="">è¯·é€‰æ‹©æ”¶å…¥ç±»å‹</option>
                                        <option value="w2">W-2å·¥èµ„æ”¶å…¥</option>
                                        <option value="self_employed">è‡ªé›‡æ”¶å…¥</option>
                                        <option value="investment">æŠ•èµ„æ”¶å…¥</option>
                                        <option value="other">å…¶ä»–</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šç‰¹æ®Šæƒ…å†µ (åŠ¨æ€æ˜¾ç¤º) -->
                        <div class="form-section hidden" id="section-special">
                            <h3 class="section-title"><i class="fas fa-star"></i> ç‰¹æ®Šæƒ…å†µ</h3>
                            <div class="form-row">
                                <div class="form-group hidden" id="militaryGroup">
                                    <label>æ‚¨æˆ–æ‚¨çš„é…å¶æ˜¯å¦æ˜¯ç°å½¹æˆ–é€€å½¹å†›äººï¼Ÿ</label>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="military_yes" name="military" value="yes">
                                            <label for="military_yes">æ˜¯</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="military_no" name="military" value="no">
                                            <label for="military_no">å¦</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group hidden" id="selfEmployedGroup">
                                    <label>æ‚¨æ˜¯å¦æœ‰è‡ªé›‡æ”¶å…¥ï¼Ÿ</label>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="selfEmployed_yes" name="selfEmployed" value="yes">
                                            <label for="selfEmployed_yes">æ˜¯</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="selfEmployed_no" name="selfEmployed" value="no">
                                            <label for="selfEmployed_no">å¦</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group hidden" id="taxReturnsGroup">
                                    <label>æ‚¨æ˜¯å¦æœ‰2å¹´ä»¥ä¸Šçš„ç¨å•è®°å½•ï¼Ÿ</label>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="taxReturns_yes" name="taxReturns" value="yes">
                                            <label for="taxReturns_yes">æ˜¯</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="taxReturns_no" name="taxReturns" value="no">
                                            <label for="taxReturns_no">å¦</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç¬¬å››éƒ¨åˆ†ï¼šä¿¡æ¯æ±‡æ€» (è°ƒè¯•ä¿¡æ¯ - åŠ¨æ€æ˜¾ç¤º) -->
                        <div class="form-section hidden" id="section-summary">
                            <h3 class="section-title" style="color: #6c757d; border-bottom-color: #adb5bd;"><i class="fas fa-bug" style="color: #6c757d;"></i> è°ƒè¯•ä¿¡æ¯æ±‡æ€» <small style="font-size: 11px; font-weight: normal; color: #6c757d; margin-left: 10px;">(ä»…ä¾›å¼€å‘è°ƒè¯•ä½¿ç”¨)</small></h3>
                            <div class="summary-box">
                                <h4>å·²æ”¶é›†ä¿¡æ¯</h4>
                                <div class="summary-grid" id="summaryGrid">
                                    <!-- åŠ¨æ€ç”Ÿæˆæ±‡æ€»ä¿¡æ¯ -->
                                </div>
                            </div>
                        </div>

                        <div class="buttons">
                            <button type="button" class="btn btn-secondary" id="resetBtn">
                                <i class="fas fa-redo"></i> é‡æ–°å¡«å†™
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> å¥½çš„ï¼Œå°±æ˜¯è¿™æ ·
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç¾å›½ä¸»è¦åŸå¸‚æ•°æ®(ç®€åŒ–ç‰ˆ,å®é™…é¡¹ç›®å¯ä»¥ä½¿ç”¨å¤–éƒ¨åº“å¦‚us-cities)
        const usCities = [
            { city: "Los Angeles", county: "Los Angeles County", state: "California" },
            { city: "San Francisco", county: "San Francisco County", state: "California" },
            { city: "New York", county: "New York County", state: "New York" },
            { city: "Chicago", county: "Cook County", state: "Illinois" },
            { city: "Houston", county: "Harris County", state: "Texas" },
            { city: "Phoenix", county: "Maricopa County", state: "Arizona" },
            { city: "Philadelphia", county: "Philadelphia County", state: "Pennsylvania" },
            { city: "San Antonio", county: "Bexar County", state: "Texas" },
            { city: "San Diego", county: "San Diego County", state: "California" },
            { city: "Dallas", county: "Dallas County", state: "Texas" },
            { city: "San Jose", county: "Santa Clara County", state: "California" },
            { city: "Austin", county: "Travis County", state: "Texas" },
            { city: "Jacksonville", county: "Duval County", state: "Florida" },
            { city: "Fort Worth", county: "Tarrant County", state: "Texas" },
            { city: "Columbus", county: "Franklin County", state: "Ohio" },
            { city: "Charlotte", county: "Mecklenburg County", state: "North Carolina" },
            { city: "San Francisco", county: "San Francisco County", state: "California" },
            { city: "Indianapolis", county: "Marion County", state: "Indiana" },
            { city: "Seattle", county: "King County", state: "Washington" },
            { city: "Denver", county: "Denver County", state: "Colorado" },
            { city: "Washington", county: "District of Columbia", state: "Washington, D.C." },
            { city: "Boston", county: "Suffolk County", state: "Massachusetts" },
            { city: "El Paso", county: "El Paso County", state: "Texas" },
            { city: "Nashville", county: "Davidson County", state: "Tennessee" },
            { city: "Detroit", county: "Wayne County", state: "Michigan" },
            { city: "Portland", county: "Multnomah County", state: "Oregon" },
            { city: "Las Vegas", county: "Clark County", state: "Nevada" },
            { city: "Memphis", county: "Shelby County", state: "Tennessee" },
            { city: "Louisville", county: "Jefferson County", state: "Kentucky" },
            { city: "Baltimore", county: "Baltimore City", state: "Maryland" }
        ];

        // Initialize ChatKit SDK
        const kit = ChatKit.init({
            pageId: 'loankit',
            onReady: function() {
                console.log('Connected to parent chat interface');
                setTimeout(() => kit.autoResize(), 100);
            }
        });

        // ç›‘å¬å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´é«˜åº¦
        function autoResizeOnChange() {
            setTimeout(() => kit.autoResize(), 50);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loanForm');
            const loanPurpose = document.getElementById('loanPurpose');
            const incomeType = document.getElementById('incomeType');
            const militaryGroup = document.getElementById('militaryGroup');
            const selfEmployedGroup = document.getElementById('selfEmployedGroup');
            const taxReturnsGroup = document.getElementById('taxReturnsGroup');
            const sectionSpecial = document.getElementById('section-special');
            const sectionSummary = document.getElementById('section-summary');
            const summaryGrid = document.getElementById('summaryGrid');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const resetBtn = document.getElementById('resetBtn');
            const submitBtn = document.getElementById('submitBtn');

            // åœ°ç‚¹æœç´¢ç›¸å…³å…ƒç´ 
            const propertyLocation = document.getElementById('propertyLocation');
            const locationDropdown = document.getElementById('locationDropdown');
            const locationOptions = document.getElementById('locationOptions');
            const locationSearchContainer = document.getElementById('locationSearchContainer');

            // åˆå§‹åŒ–åœ°ç‚¹æœç´¢åŠŸèƒ½
            initLocationSearch();
            
            // å­—æ®µæ˜¾ç¤ºåç§°æ˜ å°„
            const fieldLabels = {
                propertyLocation: 'æˆ¿äº§åœ°ç‚¹',
                loanPurpose: 'è´·æ¬¾ç›®çš„',
                propertyType: 'æˆ¿äº§ç±»å‹',
                propertyStatus: 'æˆ¿äº§ç°çŠ¶',
                loanAmount: 'è´·æ¬¾é‡‘é¢',
                downPayment: 'é¦–ä»˜æ¯”ä¾‹',
                creditScore: 'ä¿¡ç”¨åˆ†æ•°',
                incomeType: 'æ”¶å…¥ç±»å‹',
                military: 'å†›äººèº«ä»½',
                selfEmployed: 'è‡ªé›‡æ”¶å…¥',
                taxReturns: 'ç¨å•è®°å½•'
            };
            
            // å­—æ®µå€¼æ˜¾ç¤ºæ˜ å°„
            const valueLabels = {
                loanPurpose: {
                    purchase: 'è´­ä¹°è‡ªä½æˆ¿',
                    refinance: 'å†èèµ„/è½¬è´·',
                    investment: 'æŠ•èµ„æˆ¿',
                    second_home: 'ç¬¬äºŒå¥—æˆ¿'
                },
                propertyType: {
                    single_family: 'ç‹¬ç«‹å±‹',
                    condo: 'å…¬å¯“',
                    townhouse: 'è”æ’åˆ«å¢…',
                    multi_unit: 'å¤šå•å…ƒä½å®…',
                    commercial: 'å•†ä¸šåœ°äº§'
                },
                propertyStatus: {
                    pre_construction: 'åœ¨å»º/é¢„å”®',
                    existing: 'ç°æˆ¿',
                    foreclosure: 'æ³•æ‹æˆ¿'
                },
                downPayment: {
                    '0-5': '0-5%',
                    '5-10': '5-10%',
                    '10-20': '10-20%',
                    '20+': '20%+'
                },
                creditScore: {
                    '300-579': '300-579 (è¾ƒå·®)',
                    '580-669': '580-669 (ä¸€èˆ¬)',
                    '670-739': '670-739 (è‰¯å¥½)',
                    '740-799': '740-799 (å¾ˆå¥½)',
                    '800-850': '800-850 (ä¼˜ç§€)'
                },
                incomeType: {
                    w2: 'W-2å·¥èµ„æ”¶å…¥',
                    self_employed: 'è‡ªé›‡æ”¶å…¥',
                    investment: 'æŠ•èµ„æ”¶å…¥',
                    other: 'å…¶ä»–'
                },
                military: {
                    yes: 'æ˜¯',
                    no: 'å¦'
                },
                selfEmployed: {
                    yes: 'æ˜¯',
                    no: 'å¦'
                },
                taxReturns: {
                    yes: 'æ˜¯',
                    no: 'å¦'
                }
            };

            // åœ°ç‚¹æœç´¢åŠŸèƒ½
            function initLocationSearch() {
                propertyLocation.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    if (searchTerm.length < 1) {
                        locationDropdown.classList.remove('show');
                        return;
                    }

                    // æœç´¢åŸå¸‚
                    const matchedCities = usCities.filter(city =>
                        city.city.toLowerCase().includes(searchTerm)
                    );

                    // æ›´æ–°é€‰é¡¹
                    locationOptions.innerHTML = '';
                    matchedCities.slice(0, 10).forEach(city => {
                        const option = document.createElement('div');
                        option.className = 'location-option';
                        option.innerHTML = `
                            <span class="location-option-name">${city.city}</span>
                            <span class="location-option-state">${city.state}</span>
                        `;
                        option.addEventListener('click', function() {
                            propertyLocation.value = `${city.city}, ${city.county}, ${city.state}`;
                            locationDropdown.classList.remove('show');
                            updateProgress();
                            updateSummary();
                        });
                        locationOptions.appendChild(option);
                    });

                    // æ˜¾ç¤º/éšè—ä¸‹æ‹‰æ¡†
                    if (matchedCities.length > 0) {
                        locationDropdown.classList.add('show');
                    } else {
                        locationOptions.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d; font-size: 13px;">æœªæ‰¾åˆ°åŒ¹é…çš„åŸå¸‚</div>';
                        locationDropdown.classList.add('show');
                    }
                });

                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
                document.addEventListener('click', function(e) {
                    if (!locationSearchContainer.contains(e.target)) {
                        locationDropdown.classList.remove('show');
                    }
                });

                // è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºæç¤º
                propertyLocation.addEventListener('focus', function() {
                    if (!this.value || this.value.length < 1) {
                        locationOptions.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d; font-size: 13px;">è¯·è¾“å…¥åŸå¸‚åè¿›è¡Œæœç´¢ï¼Œä¾‹å¦‚ï¼šLos Angeles</div>';
                        locationDropdown.classList.add('show');
                    }
                });
            }

            // æ›´æ–°è¿›åº¦æ¡
            function updateProgress() {
                const requiredFields = form.querySelectorAll('[required]');
                const filledFields = Array.from(requiredFields).filter(field => {
                    if (field.type === 'radio') {
                        const name = field.name;
                        return form.querySelector(`input[name="${name}"]:checked`);
                    }
                    return field.value.trim() !== '';
                });
                
                const progress = Math.min(25 + (filledFields.length / requiredFields.length) * 75, 100);
                progressFill.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
            }
            
            // åŠ¨æ€æ˜¾ç¤º/éšè—ç‰¹æ®Šé—®é¢˜
            function toggleSpecialQuestions() {
                const purpose = loanPurpose.value;
                const incomeTypeValue = incomeType.value;

                // é‡ç½®ç‰¹æ®Šé—®é¢˜
                militaryGroup.classList.add('hidden');
                selfEmployedGroup.classList.add('hidden');
                taxReturnsGroup.classList.add('hidden');
                sectionSpecial.classList.add('hidden');

                // æ˜¾ç¤ºå†›äººé—®é¢˜ï¼ˆå¦‚æœæ˜¯è‡ªä½æˆ–å†èèµ„ï¼‰
                if (purpose === 'purchase' || purpose === 'refinance') {
                    militaryGroup.classList.remove('hidden');
                }

                // æ˜¾ç¤ºè‡ªé›‡æ”¶å…¥é—®é¢˜ï¼ˆå¦‚æœæ˜¯W-2æ”¶å…¥ï¼‰
                if (incomeTypeValue === 'w2') {
                    selfEmployedGroup.classList.remove('hidden');
                }

                // æ˜¾ç¤ºç¨å•é—®é¢˜ï¼ˆå¦‚æœæ˜¯è‡ªé›‡æˆ–æŠ•èµ„æ”¶å…¥ï¼‰
                if (incomeTypeValue === 'self_employed' || incomeTypeValue === 'investment') {
                    taxReturnsGroup.classList.remove('hidden');
                }

                // å¦‚æœæœ‰ä»»ä½•ç‰¹æ®Šé—®é¢˜æ˜¾ç¤ºï¼Œå°±æ˜¾ç¤ºæ•´ä¸ªç‰¹æ®Šéƒ¨åˆ†
                if (!militaryGroup.classList.contains('hidden') ||
                    !selfEmployedGroup.classList.contains('hidden') ||
                    !taxReturnsGroup.classList.contains('hidden')) {
                    sectionSpecial.classList.remove('hidden');
                }

                // æ›´æ–°ä¿¡æ¯æ±‡æ€»
                updateSummary();
                
                // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                autoResizeOnChange();
            }
            
            // æ›´æ–°ä¿¡æ¯æ±‡æ€»
            function updateSummary() {
                const location = document.getElementById('propertyLocation').value;
                const purpose = loanPurpose.value;
                const propertyType = document.getElementById('propertyType').value;
                const propertyStatus = document.getElementById('propertyStatus').value;
                const loanAmount = document.getElementById('loanAmount').value;
                const downPayment = document.getElementById('downPayment').value;
                const creditScore = document.getElementById('creditScore').value;
                const incomeType = form.querySelector('input[name="incomeType"]:checked');
                const military = form.querySelector('input[name="military"]:checked');
                const selfEmployed = form.querySelector('input[name="selfEmployed"]:checked');
                const taxReturns = form.querySelector('input[name="taxReturns"]:checked');
                
                // æ”¶é›†æ‰€æœ‰æ•°æ®
                const formData = {
                    propertyLocation: location,
                    loanPurpose: purpose,
                    propertyType: propertyType,
                    propertyStatus: propertyStatus,
                    loanAmount: loanAmount,
                    downPayment: downPayment,
                    creditScore: creditScore,
                    incomeType: incomeType ? incomeType.value : '',
                    military: military ? military.value : '',
                    selfEmployed: selfEmployed ? selfEmployed.value : '',
                    taxReturns: taxReturns ? taxReturns.value : ''
                };
                
                // æ¸…ç©ºæ±‡æ€»ç½‘æ ¼
                summaryGrid.innerHTML = '';
                
                // æ·»åŠ éç©ºå­—æ®µåˆ°æ±‡æ€»
                Object.keys(formData).forEach(key => {
                    if (formData[key]) {
                        const summaryItem = document.createElement('div');
                        summaryItem.className = 'summary-item';
                        
                        const label = document.createElement('div');
                        label.className = 'summary-label';
                        label.textContent = fieldLabels[key] || key;
                        
                        const value = document.createElement('div');
                        value.className = 'summary-value';
                        
                        // è·å–æ˜¾ç¤ºçš„æ–‡æœ¬å€¼
                        let displayValue = formData[key];
                        if (valueLabels[key] && valueLabels[key][formData[key]]) {
                            displayValue = valueLabels[key][formData[key]];
                        }
                        
                        // ç‰¹æ®Šå¤„ç†è´·æ¬¾é‡‘é¢
                        if (key === 'loanAmount') {
                            displayValue = '$' + parseInt(displayValue).toLocaleString();
                        }
                        
                        value.textContent = displayValue;
                        
                        summaryItem.appendChild(label);
                        summaryItem.appendChild(value);
                        summaryGrid.appendChild(summaryItem);
                    }
                });

                // å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå­—æ®µæœ‰å€¼ï¼Œæ˜¾ç¤ºæ±‡æ€»éƒ¨åˆ†
                if (Object.values(formData).some(value => value)) {
                    sectionSummary.classList.remove('hidden');
                } else {
                    sectionSummary.classList.add('hidden');
                }

                // æ›´æ–°è¿›åº¦
                updateProgress();
                
                // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                autoResizeOnChange();
            }

            
            // äº‹ä»¶ç›‘å¬
            loanPurpose.addEventListener('change', toggleSpecialQuestions);
            incomeType.addEventListener('change', toggleSpecialQuestions);

            // ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–
            form.addEventListener('input', function() {
                updateProgress();
                updateSummary();
            });

            form.addEventListener('change', function() {
                updateProgress();
                updateSummary();
            });
            
            // è¡¨å•æäº¤
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                // æ”¶é›†æ‰€æœ‰è¡¨å•æ•°æ®ï¼ˆåŒ…æ‹¬selectå’Œradioï¼‰
                const formValues = {
                    propertyLocation: document.getElementById('propertyLocation').value,
                    loanPurpose: document.getElementById('loanPurpose').value,
                    propertyType: document.getElementById('propertyType').value,
                    propertyStatus: document.getElementById('propertyStatus').value,
                    loanAmount: document.getElementById('loanAmount').value,
                    downPayment: document.getElementById('downPayment').value,
                    creditScore: document.getElementById('creditScore').value,
                    incomeType: document.getElementById('incomeType').value
                };

                // æ”¶é›†radioé€‰é¡¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const militaryRadio = form.querySelector('input[name="military"]:checked');
                if (militaryRadio) formValues.military = militaryRadio.value;

                const selfEmployedRadio = form.querySelector('input[name="selfEmployed"]:checked');
                if (selfEmployedRadio) formValues.selfEmployed = selfEmployedRadio.value;

                const taxReturnsRadio = form.querySelector('input[name="taxReturns"]:checked');
                if (taxReturnsRadio) formValues.taxReturns = taxReturnsRadio.value;

                // æ·»åŠ æ—¶é—´æˆ³
                formValues.timestamp = new Date().toISOString();

                // å‘é€æ•°æ®åˆ°çˆ¶é¡µé¢èŠå¤©ç•Œé¢
                kit.sendData({
                    type: 'form_submit',
                    data: formValues
                });

                // é”å®šè¡¨å•ï¼šç¦ç”¨æ‰€æœ‰è¾“å…¥
                form.querySelectorAll('input, select, textarea').forEach(el => {
                    el.disabled = true;
                });

                // éšè—æ‰€æœ‰æŒ‰é’®
                document.querySelector('.buttons').style.display = 'none';
                
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨API
                console.log('æäº¤çš„è¡¨å•æ•°æ®:', formValues);
                console.log('JSONæ ¼å¼:', JSON.stringify(formValues, null, 2));
            });
            
            // é‡ç½®è¡¨å•
            resetBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä¿¡æ¯å—ï¼Ÿ')) {
                    form.reset();
                    sectionSpecial.classList.add('hidden');
                    sectionSummary.classList.add('hidden');
                    progressFill.style.width = '25%';
                    progressPercent.textContent = '25%';
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> å¥½çš„ï¼Œå°±æ˜¯è¿™æ ·';
                    submitBtn.disabled = false;
                    submitBtn.style.background = '';
                }
            });
            
            // åˆå§‹æ›´æ–°è¿›åº¦
            updateProgress();
        });
    </script>
</body>
</html>
